# Render PostgreSQL Connection Patterns

## Basic Connection

```javascript
require('dotenv').config();
const { Pool } = require('pg');

const renderPool = new Pool({
  connectionString: process.env.RENDER_DATABASE_URL,
  ssl: { rejectUnauthorized: false }
});
```

**Key Points:**
- **SSL required:** Render PostgreSQL requires SSL connection
- **`rejectUnauthorized: false`:** Required because Render uses self-signed certificates
- **Environment variable:** Store connection string in `.env` file

## Environment Variables

**File:** `backend/.env`

```env
# Local PostgreSQL
DATABASE_URL=postgresql://postgres:your_password@localhost:5432/kkp_platform

# Render PostgreSQL
RENDER_DATABASE_URL=postgresql://kkp_db_user:dE3QmTF614lekaX1AZ7rOktquk4Kc8p2@dpg-d5cga6ogjchc73cnuuk0-a.frankfurt-postgres.render.com/kkp_db
```

**Security:**
- Never commit `.env` to git
- Add `.env` to `.gitignore`
- Use different passwords for local and production

## Connection String Format

```
postgresql://[username]:[password]@[host]:[port]/[database]
```

**Render Example:**
```
postgresql://kkp_db_user:PASSWORD@dpg-XXXXX-a.frankfurt-postgres.render.com/kkp_db
```

**Components:**
- `username`: Render database user (e.g., `kkp_db_user`)
- `password`: Auto-generated by Render (long random string)
- `host`: Render hostname (includes region, e.g., `frankfurt-postgres.render.com`)
- `port`: Default 5432 (included in Render connection string)
- `database`: Database name (e.g., `kkp_db`)

## Connection with Client

For single-query operations:

```javascript
async function simpleQuery() {
  try {
    const result = await renderPool.query('SELECT NOW()');
    console.log(result.rows[0]);
  } catch (error) {
    console.error('Query error:', error);
  } finally {
    await renderPool.end();
  }
}
```

## Connection with Transaction

For migrations (recommended):

```javascript
async function migration() {
  const client = await renderPool.connect();

  try {
    await client.query('BEGIN');

    // Your queries here
    await client.query('CREATE TABLE ...');
    await client.query('INSERT INTO ...');

    await client.query('COMMIT');
  } catch (error) {
    await client.query('ROLLBACK');
    console.error('Transaction error:', error);
    throw error;
  } finally {
    client.release();
    await renderPool.end();
  }
}
```

**Benefits:**
- Automatic rollback on error
- All changes applied atomically
- No partial migrations

## Dual Connection (Local + Render)

For data synchronization:

```javascript
const localPool = new Pool({
  connectionString: process.env.DATABASE_URL
});

const renderPool = new Pool({
  connectionString: process.env.RENDER_DATABASE_URL,
  ssl: { rejectUnauthorized: false }
});

async function syncData() {
  const localClient = await localPool.connect();
  const renderClient = await renderPool.connect();

  try {
    // Get data from local
    const data = await localClient.query('SELECT * FROM table_name');

    // Insert to Render
    await renderClient.query('BEGIN');
    for (const row of data.rows) {
      await renderClient.query('INSERT INTO table_name VALUES ($1, $2)', [row.col1, row.col2]);
    }
    await renderClient.query('COMMIT');

  } catch (error) {
    await renderClient.query('ROLLBACK');
    throw error;
  } finally {
    localClient.release();
    renderClient.release();
    await localPool.end();
    await renderPool.end();
  }
}
```

## Connection Pooling

Pool configuration options:

```javascript
const pool = new Pool({
  connectionString: process.env.RENDER_DATABASE_URL,
  ssl: { rejectUnauthorized: false },
  max: 10,                  // Max clients in pool
  idleTimeoutMillis: 30000, // Close idle clients after 30s
  connectionTimeoutMillis: 2000, // Timeout after 2s
});
```

**For KKP Platform:**
- Default pool settings work well
- Only customize if experiencing connection issues
- Render free tier has connection limits

## Error Handling

```javascript
async function robustConnection() {
  let client;

  try {
    client = await renderPool.connect();
    await client.query('BEGIN');

    // Your queries

    await client.query('COMMIT');

  } catch (error) {
    if (client) {
      await client.query('ROLLBACK');
    }

    // Handle specific errors
    if (error.code === '23505') {
      console.error('Duplicate key violation');
    } else if (error.code === '42P01') {
      console.error('Table does not exist');
    } else {
      console.error('Database error:', error.message);
    }

    throw error;

  } finally {
    if (client) {
      client.release();
    }
    await renderPool.end();
  }
}
```

## Common Error Codes

| Code | Meaning | Fix |
|------|---------|-----|
| 23505 | Duplicate key violation | Check UNIQUE constraints |
| 42P01 | Undefined table | Create table first |
| 42703 | Undefined column | Add column or fix column name |
| 42601 | Syntax error | Check SQL syntax |
| 08006 | Connection failure | Check RENDER_DATABASE_URL |
| 28P01 | Invalid password | Verify credentials in .env |

## Testing Connection

**Quick test script:**

```javascript
require('dotenv').config();
const { Pool } = require('pg');

const pool = new Pool({
  connectionString: process.env.RENDER_DATABASE_URL,
  ssl: { rejectUnauthorized: false }
});

async function testConnection() {
  try {
    const result = await pool.query('SELECT NOW(), version()');
    console.log('✅ Connection successful!');
    console.log('   Server time:', result.rows[0].now);
    console.log('   PostgreSQL version:', result.rows[0].version);
  } catch (error) {
    console.error('❌ Connection failed:', error.message);
  } finally {
    await pool.end();
  }
}

testConnection();
```

**Run:** `node backend/test-connection.js`

## Getting Connection String from Render

1. Go to Render Dashboard
2. Select your PostgreSQL database
3. Click "Info" or "Connect"
4. Copy "External Database URL"
5. Add to `.env` as `RENDER_DATABASE_URL`

**Format:**
```
postgresql://user:pass@dpg-xxxxx-a.region.render.com/database
```

## Security Best Practices

1. **Never hardcode credentials:**
   ```javascript
   // ❌ BAD
   const pool = new Pool({
     connectionString: 'postgresql://user:pass@host/db'
   });

   // ✅ GOOD
   const pool = new Pool({
     connectionString: process.env.RENDER_DATABASE_URL
   });
   ```

2. **Use environment-specific variables:**
   ```javascript
   const connectionString = process.env.NODE_ENV === 'production'
     ? process.env.RENDER_DATABASE_URL
     : process.env.DATABASE_URL;
   ```

3. **Add .env to .gitignore:**
   ```
   .env
   .env.local
   .env.production
   ```

4. **Rotate credentials periodically:**
   - Render allows resetting database passwords
   - Update `.env` after rotation
   - No code changes needed

## Troubleshooting

### SSL Error

**Error:** `no pg_hba.conf entry for host`

**Fix:**
```javascript
ssl: { rejectUnauthorized: false }
```

### Connection Timeout

**Error:** `timeout expired`

**Causes:**
- Render database is asleep (free tier)
- Network issues
- Wrong connection string

**Fix:**
- Wait for database to wake up (30-60 seconds)
- Verify RENDER_DATABASE_URL in .env
- Test with simple query first

### Too Many Connections

**Error:** `sorry, too many clients already`

**Causes:**
- Not closing pool connections
- Pool max exceeded
- Render free tier limits

**Fix:**
```javascript
// Always close pool
await pool.end();

// Or reduce pool size
const pool = new Pool({
  connectionString: process.env.RENDER_DATABASE_URL,
  ssl: { rejectUnauthorized: false },
  max: 5  // Reduce from default 10
});
```

## Integration with KKP Platform

**Example from existing migration:**

```javascript
// From migrate-surec-schema.js
const renderPool = new Pool({
  connectionString: process.env.RENDER_DATABASE_URL,
  ssl: { rejectUnauthorized: false }
});

async function migrateSurecSchema() {
  const client = await renderPool.connect();

  try {
    console.log('Migrating surec table schemas on Render...\n');
    await client.query('BEGIN');

    // Migration logic here

    await client.query('COMMIT');
    console.log('\n✅ Migration completed successfully!');

  } catch (error) {
    await client.query('ROLLBACK');
    console.error('\n❌ Error during migration:', error.message);
    process.exit(1);
  } finally {
    client.release();
    await renderPool.end();
  }
}
```

This pattern is used consistently across all KKP Platform migrations.
